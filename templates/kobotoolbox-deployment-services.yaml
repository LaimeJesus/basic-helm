{{ range $idx, $service := (merge .Values.services .Values.apps) }}
{{- if $service.deploy }}
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    io.kompose.service: {{ $idx }}
  name: {{ $idx }}
spec:
  replicas: 1
  selector:
    matchLabels:
      io.kompose.service: {{ $idx }}
  strategy:
    type: Recreate
  template:
    metadata:
      labels:
        io.kompose.service: {{ $idx }}
    spec:
      {{- if not (empty $service.initContainers) }}
      initContainers:
        {{- with $service.initContainers }}
          {{- toYaml . | trim | nindent 8 }}
        {{- end }}
      {{- end }}
      containers:
      - name: {{ $idx }}
        image: {{ $service.image }}
        imagePullPolicy: {{ $.Values.imagePullPolicy }}
        env:
        {{- if has $idx (list "nginx" "kpi" "kobocat" "enketo-express") }}
          {{ template "apps" $.Values }}
        {{- end }}
        {{- if eq $idx "kobocat" }}
          {{ template "kobocat" $.Values }}
        {{- end }}
        {{- if eq $idx "kpi" }}
          {{ template "kpi" $.Values }}
        {{- end }}
        {{- if eq $idx "nginx" }}
          {{ template "nginx" $.Values }}
        {{- end }}
        {{- if eq $idx "rabbit" }}
          {{ template "rabbit" $.Values }}
        {{- end }}
        {{- if eq $idx "db-backup" }}
          {{ template "db-backup" $.Values }}
        {{- end }}
        {{- if eq $idx "postgres" }}
          {{ template "postgres" $.Values }}
        {{- end }}
        {{- if eq $idx "mongo" }}
          {{ template "mongo" $.Values }}
        {{- end }}
        {{- if eq $idx "borg-backup-service" }}
          {{ template "borg-backup-service" $.Values }}
        {{- end }}
        {{- if eq $idx "borg-backup-service-server" }}
          {{ template "borg-backup-service-server" $.Values }}
        {{- end }}
        {{- if not (empty .volumes) }}
        volumeMounts:
          {{- with .volumes }}
            {{- range $idx, $val := .}}
          - mountPath: {{ $val }}
            name: {{ $idx }}
            {{- end }}
          {{- end }}
        {{- end }}
      imagePullSecrets:
        - name: {{ $.Values.imagePullSecrets }}
      restartPolicy: {{ $.Values.restartPolicy }}
      serviceAccountName: ""
      {{- if not (empty .volumes) }}
      volumes:
        {{- with $service.volumes }}
            {{- range $idx, $val := .}}
        - name: {{ $idx }}
          persistentVolumeClaim:
            claimName: {{ $idx }}
            {{- end }}
        {{- end }}
      {{- end }}
status: {}
{{- end }}
{{ end }}
